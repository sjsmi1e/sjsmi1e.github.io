<!DOCTYPE html>
<html>
<head>
    <meta name="google-site-verification" content="3wLXF9YV1kwKAVqbZA3aJPfJ09XOP39gXhxoO_Wbymc"/>
    <meta name="baidu-site-verification" content="code-Gipv9WAl6W"/>
    <meta charset="utf-8">
<!--    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">-->
    <script type="text/javascript" src="/js/sha256.js"></script>
    <script type="text/javascript">
        if ('') {
            var pwd = prompt('请输入文章密码');
            if (pwd && sha256(pwd) == '') {

            } else {
                alert('密码错误');
                history.back();
            }
        }
    </script>
    
    
    <title>
        最简单的 6 种防止数据重复提交的方法！ |
        
        MY STUDY BLOG
         | 喜欢争取，得到珍惜
        
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="java">
    <link rel="shortcut icon" href="/img/logo.png">
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:    true,
            lv: JSON.parse('{"enable":true,"app_id":"EtO4sVlSFfGKFVhp1xsCshAD-gzGzoHsz","app_key":"DVHJikdL744Xv15hyvirW00X","icon":true}'),
            v: JSON.parse('{"enable":true,"appid":"EtO4sVlSFfGKFVhp1xsCshAD-gzGzoHsz","appkey":"DVHJikdL744Xv15hyvirW00X","notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts = [];
    </script>
    
    <link rel="stylesheet" href="/layui/css/layui.css">
    <script src="/layui/layui.js"></script>
    <script type="text/javascript" src="/js/pjax.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css"/>
<link rel="alternate" href="/atom.xml" title="MY STUDY BLOG" type="application/atom+xml">
</head>

<link rel="stylesheet" href="/css/alert.css">
<!-- require APlayer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">

<body>
<div id="loading" class="active"></div>

<aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/banner.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Smile</h5>
          <a href="mailto:1043110319@qq.com" title="1043110319@qq.com" class="mail">
            
              <span>1</span>
            
              <span>0</span>
            
              <span>4</span>
            
              <span>3</span>
            
              <span>1</span>
            
              <span>1</span>
            
              <span>0</span>
            
              <span>3</span>
            
              <span>1</span>
            
              <span>9</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/sjsmi1e" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="mailto:1043110319@qq.com" target="_blank">
                  <i class="icon icon-lg icon-envelope"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章历史
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                关于我
              </a>
            </li>
        
            <li class="">
              <a href="/timeline"  >
                <i class="icon icon-lg icon-plus-square"></i>
                时间轴
              </a>
            </li>
        
            <li class="">
              <a href="/photos"  >
                <i class="icon icon-lg icon-plus-square"></i>
                相册
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

<main id="main">
    <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>最简单的 6 种防止数据重复提交的方法！</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/header.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">最简单的 6 种防止数据重复提交的方法！</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-08-02T06:30:10.000Z" itemprop="datePublished" class="page-time">
  2020-08-02
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/java/">java</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-java/最简单的-6-种防止数据重复提交的方法！"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">最简单的 6 种防止数据重复提交的方法！</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-08-02 14:30:10" datetime="2020-08-02T06:30:10.000Z"  itemprop="datePublished">2020-08-02</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/java/">java</a></li></ul>



            
	<span id="/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/" class="leancloud_visitors" data-flag-title="最简单的 6 种防止数据重复提交的方法！" title="最简单的 6 种防止数据重复提交的方法！">
		
			<i class="icon icon-eye"></i>
		
		<span class="leancloud-visitors-count"></span>
	</span>
 

            
    <span class="leancloud-comment">
        <i class="icon icon-comment-o"></i>
        <a href="/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/#comment">
            <span class="valine-comment-count" data-xid="/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/"></span>
        </a>
    </span>



            
            <span class="post-count">文章字数: 2,983</span>
<span class="post-count">阅读时长 ≈ 13分钟</span>
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <blockquote>
<p>转载:<a href="https://mp.weixin.qq.com/s/kOADZRd5hI1H-7_zuXJsAw" target="_blank" rel="noopener">点击查看原文</a></p>
</blockquote>
<h2 id="模拟用户场景"><a href="#模拟用户场景" class="headerlink" title="模拟用户场景"></a>模拟用户场景</h2><p>根据朋友的反馈，大致的场景是这样的，如下图所示：</p>
<figure class="image-box">
                <a rel=最简单的 6 种防止数据重复提交的方法！ href="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143342.gif" title="" data-fancybox="images"><img src="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143342.gif" alt="" title="" class=""></a>
                <p></p>
            </figure>
<a id="more"></a>
<p>简化的模拟代码如下（基于 Spring Boot）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 被重复请求的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是磊哥就想到：通过前、后端分别拦截的方式来解决数据重复提交的问题。</p>
<h2 id="前端拦截"><a href="#前端拦截" class="headerlink" title="前端拦截"></a>前端拦截</h2><p>前端拦截是指通过 HTML 页面来拦截重复请求，比如在用户点击完“提交”按钮后，我们可以把按钮设置为不可用或者隐藏状态。</p>
<p>执行效果如下图所示：</p>
<figure class="image-box">
                <a rel=最简单的 6 种防止数据重复提交的方法！ href="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143537.gif" title="" data-fancybox="images"><img src="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143537.gif" alt="" title="" class=""></a>
                <p></p>
            </figure>
<p>前端拦截的实现代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function subCli()&#123;</span></span><br><span class="line"><span class="undefined">        // 按钮设置为不可用</span></span><br><span class="line"><span class="undefined">        document.getElementById("btn_sub").disabled="disabled";</span></span><br><span class="line"><span class="undefined">        document.getElementById("dv1").innerText = "按钮被点击了~";</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"margin-top: 100px;margin-left: 100px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"btn_sub"</span> <span class="attr">type</span>=<span class="string">"button"</span>  <span class="attr">value</span>=<span class="string">" 提 交 "</span>  <span class="attr">onclick</span>=<span class="string">"subCli()"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"dv1"</span> <span class="attr">style</span>=<span class="string">"margin-top: 80px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但前端拦截有一个致命的问题，如果是懂行的程序员或非法用户可以直接绕过前端页面，通过模拟请求来重复提交请求，比如充值了 100 元，重复提交了 10 次变成了 1000 元（瞬间发现了一个致富的好办法）。</p>
<p>所以除了前端拦截一部分正常的误操作之外，后端的拦截也是必不可少。</p>
<h2 id="后端拦截"><a href="#后端拦截" class="headerlink" title="后端拦截"></a>后端拦截</h2><p>后端拦截的实现思路是在方法执行之前，先判断此业务是否已经执行过，如果执行过则不再执行，否则就正常执行。</p>
<p>我们将请求的业务 ID 存储在内存中，并且通过添加互斥锁来保证多线程下的程序执行安全，大体实现思路如下图所示：</p>
<figure class="image-box">
                <a rel=最简单的 6 种防止数据重复提交的方法！ href="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/image-20200802143638247.png" title="" data-fancybox="images"><img src="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/image-20200802143638247.png" alt="" title="" class=""></a>
                <p></p>
            </figure>
<p>然而，将数据存储在内存中，最简单的方法就是使用 <code>HashMap</code> 存储，或者是使用 Guava Cache 也是同样的效果，但很显然 <code>HashMap</code> 可以更快的实现功能，所以我们先来实现一个 <code>HashMap</code> 的防重（防止重复）版本。</p>
<h3 id="1-基础版——HashMap"><a href="#1-基础版——HashMap" class="headerlink" title="1.基础版——HashMap"></a>1.基础版——HashMap</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通 Map 版本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存 ID 集合</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; reqCache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空判断(忽略)...</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.getClass()) &#123;</span><br><span class="line">            <span class="comment">// 重复请求判断</span></span><br><span class="line">            <span class="keyword">if</span> (reqCache.containsKey(id)) &#123;</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 存储请求 ID</span></span><br><span class="line">            reqCache.put(id, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现效果如下图所示：</p>
<figure class="image-box">
                <a rel=最简单的 6 种防止数据重复提交的方法！ href="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143707.gif" title="" data-fancybox="images"><img src="https://gitee.com/sjsmi1e/image-bed/raw/master/markdown_images/微信图片_20200802143707.gif" alt="" title="" class=""></a>
                <p></p>
            </figure>
<p><strong>存在的问题</strong>：此实现方式有一个致命的问题，因为 <code>HashMap</code> 是无限增长的，因此它会占用越来越多的内存，并且随着 <code>HashMap</code> 数量的增加查找的速度也会降低，所以我们需要实现一个可以自动“清除”过期数据的实现方案。</p>
<h3 id="2-优化版——固定大小的数组"><a href="#2-优化版——固定大小的数组" class="headerlink" title="2.优化版——固定大小的数组"></a>2.优化版——固定大小的数组</h3><p>此版本解决了 <code>HashMap</code> 无限增长的问题，它使用数组加下标计数器（reqCacheCounter）的方式，实现了固定数组的循环存储。</p>
<p>当数组存储到最后一位时，将数组的存储下标设置 0，再从头开始存储数据，实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] reqCache = <span class="keyword">new</span> String[<span class="number">100</span>]; <span class="comment">// 请求 ID 存储集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer reqCacheCounter = <span class="number">0</span>; <span class="comment">// 请求计数器（指示 ID 存储的位置）</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空判断(忽略)...</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.getClass()) &#123;</span><br><span class="line">            <span class="comment">// 重复请求判断</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.asList(reqCache).contains(id)) &#123;</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 记录请求 ID</span></span><br><span class="line">            <span class="keyword">if</span> (reqCacheCounter &gt;= reqCache.length) reqCacheCounter = <span class="number">0</span>; <span class="comment">// 重置计数器</span></span><br><span class="line">            reqCache[reqCacheCounter] = id; <span class="comment">// 将 ID 保存到缓存</span></span><br><span class="line">            reqCacheCounter++; <span class="comment">// 下标往后移一位</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-扩展版——双重检测锁-DCL"><a href="#3-扩展版——双重检测锁-DCL" class="headerlink" title="3.扩展版——双重检测锁(DCL)"></a>3.扩展版——双重检测锁(DCL)</h3><p>上一种实现方法将判断和添加业务，都放入 <code>synchronized</code> 中进行加锁操作，这样显然性能不是很高，于是我们可以使用单例中著名的 DCL（Double Checked Locking，双重检测锁）来优化代码的执行效率，实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] reqCache = <span class="keyword">new</span> String[<span class="number">100</span>]; <span class="comment">// 请求 ID 存储集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer reqCacheCounter = <span class="number">0</span>; <span class="comment">// 请求计数器（指示 ID 存储的位置）</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空判断(忽略)...</span></span><br><span class="line">        <span class="comment">// 重复请求判断</span></span><br><span class="line">        <span class="keyword">if</span> (Arrays.asList(reqCache).contains(id)) &#123;</span><br><span class="line">            <span class="comment">// 重复请求</span></span><br><span class="line">            System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.getClass()) &#123;</span><br><span class="line">            <span class="comment">// 双重检查锁（DCL,double checked locking）提高程序的执行效率</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.asList(reqCache).contains(id)) &#123;</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 记录请求 ID</span></span><br><span class="line">            <span class="keyword">if</span> (reqCacheCounter &gt;= reqCache.length) reqCacheCounter = <span class="number">0</span>; <span class="comment">// 重置计数器</span></span><br><span class="line">            reqCache[reqCacheCounter] = id; <span class="comment">// 将 ID 保存到缓存</span></span><br><span class="line">            reqCacheCounter++; <span class="comment">// 下标往后移一位</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：DCL 适用于重复提交频繁比较高的业务场景，对于相反的业务场景下 DCL 并不适用。</p>
</blockquote>
<h3 id="4-完善版——LRUMap"><a href="#4-完善版——LRUMap" class="headerlink" title="4.完善版——LRUMap"></a>4.完善版——LRUMap</h3><p>上面的代码基本已经实现了重复数据的拦截，但显然不够简洁和优雅，比如下标计数器的声明和业务处理等，但值得庆幸的是 Apache 为我们提供了一个 commons-collections 的框架，里面有一个非常好用的数据结构 <code>LRUMap</code> 可以保存指定数量的固定的数据，并且它会按照 LRU 算法，帮你清除最不常用的数据。</p>
<blockquote>
<p>小贴士：LRU 是 Least Recently Used 的缩写，即最近最少使用，是一种常用的数据淘汰算法，选择最近最久未使用的数据予以淘汰。</p>
</blockquote>
<p>首先，我们先来添加 Apache commons collections 的引用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- 集合工具类 apache commons collections --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-collections4 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LRUMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最大容量 100 个，根据 LRU 算法淘汰数据的 Map 集合</span></span><br><span class="line">    <span class="keyword">private</span> LRUMap&lt;String, Integer&gt; reqCache = <span class="keyword">new</span> LRUMap&lt;&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空判断(忽略)...</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.getClass()) &#123;</span><br><span class="line">            <span class="comment">// 重复请求判断</span></span><br><span class="line">            <span class="keyword">if</span> (reqCache.containsKey(id)) &#123;</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 存储请求 ID</span></span><br><span class="line">            reqCache.put(id, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用了 <code>LRUMap</code> 之后，代码显然简洁了很多。</p>
<h3 id="5-最终版——封装"><a href="#5-最终版——封装" class="headerlink" title="5.最终版——封装"></a>5.最终版——封装</h3><p>以上都是方法级别的实现方案，然而在实际的业务中，我们可能有很多的方法都需要防重，那么接下来我们就来封装一个公共的方法，以供所有类使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LRUMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 幂等性判断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdempotentUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 LRU(Least Recently Used，最近最少使用)算法淘汰数据的 Map 集合，最大容量 100 个</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LRUMap&lt;String, Integer&gt; reqCache = <span class="keyword">new</span> LRUMap&lt;&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 幂等性判断</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">judge</span><span class="params">(String id, Object lockClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lockClass) &#123;</span><br><span class="line">            <span class="comment">// 重复请求判断</span></span><br><span class="line">            <span class="keyword">if</span> (reqCache.containsKey(id)) &#123;</span><br><span class="line">                <span class="comment">// 重复请求</span></span><br><span class="line">                System.out.println(<span class="string">"请勿重复提交！！！"</span> + id);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 非重复请求，存储请求 ID</span></span><br><span class="line">            reqCache.put(id, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.idempote.util.IdempotentUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController4</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非空判断(忽略)...</span></span><br><span class="line">        <span class="comment">// -------------- 幂等性调用（开始） --------------</span></span><br><span class="line">        <span class="keyword">if</span> (!IdempotentUtils.judge(id, <span class="keyword">this</span>.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"执行失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// -------------- 幂等性调用（结束） --------------</span></span><br><span class="line">        <span class="comment">// 业务代码...</span></span><br><span class="line">        System.out.println(<span class="string">"添加用户ID:"</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"执行成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>小贴士：一般情况下代码写到这里就结束了，但想要更简洁也是可以实现的，你可以通过自定义注解，将业务代码写到注解中，需要调用的方法只需要写一行注解就可以防止数据重复提交了，老铁们可以自行尝试一下（需要磊哥撸一篇的，评论区留言 666）。</p>
</blockquote>
<h2 id="扩展知识——LRUMap-实现原理分析"><a href="#扩展知识——LRUMap-实现原理分析" class="headerlink" title="扩展知识——LRUMap 实现原理分析"></a>扩展知识——LRUMap 实现原理分析</h2><p>既然 <code>LRUMap</code> 如此强大，我们就来看看它是如何实现的。</p>
<p><code>LRUMap</code> 的本质是持有头结点的环回双链表结构，它的存储结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AbstractLinkedMap.LinkEntry entry;</span><br></pre></td></tr></table></figure>
<p>当调用查询方法时，会将使用的元素放在双链表 header 的前一个位置，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key, <span class="keyword">boolean</span> updateToMRU)</span> </span>&#123;</span><br><span class="line">    LinkEntry&lt;K, V&gt; entry = <span class="keyword">this</span>.getEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (updateToMRU) &#123;</span><br><span class="line">            <span class="keyword">this</span>.moveToMRU(entry);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> entry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">moveToMRU</span><span class="params">(LinkEntry&lt;K, V&gt; entry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.after != <span class="keyword">this</span>.header) &#123;</span><br><span class="line">        ++<span class="keyword">this</span>.modCount;</span><br><span class="line">        <span class="keyword">if</span> (entry.before == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Entry.before is null. This should not occur if your keys are immutable, and you have used synchronization properly."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entry.before.after = entry.after;</span><br><span class="line">        entry.after.before = entry.before;</span><br><span class="line">        entry.after = <span class="keyword">this</span>.header;</span><br><span class="line">        entry.before = <span class="keyword">this</span>.header.before;</span><br><span class="line">        <span class="keyword">this</span>.header.before.after = entry;</span><br><span class="line">        <span class="keyword">this</span>.header.before = entry;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry == <span class="keyword">this</span>.header) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't move header to MRU This should not occur if your keys are immutable, and you have used synchronization properly."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果新增元素时，容量满了就会移除 header 的后一个元素，添加源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addMapping</span><span class="params">(<span class="keyword">int</span> hashIndex, <span class="keyword">int</span> hashCode, K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断容器是否已满 </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isFull()) &#123;</span><br><span class="line">        LinkEntry&lt;K, V&gt; reuse = <span class="keyword">this</span>.header.after;</span><br><span class="line">        <span class="keyword">boolean</span> removeLRUEntry = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.scanUntilRemovable) &#123;</span><br><span class="line">            removeLRUEntry = <span class="keyword">this</span>.removeLRU(reuse);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(reuse != <span class="keyword">this</span>.header &amp;&amp; reuse != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.removeLRU(reuse)) &#123;</span><br><span class="line">                    removeLRUEntry = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                reuse = reuse.after;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (reuse == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Entry.after=null, header.after="</span> + <span class="keyword">this</span>.header.after + <span class="string">" header.before="</span> + <span class="keyword">this</span>.header.before + <span class="string">" key="</span> + key + <span class="string">" value="</span> + value + <span class="string">" size="</span> + <span class="keyword">this</span>.size + <span class="string">" maxSize="</span> + <span class="keyword">this</span>.maxSize + <span class="string">" This should not occur if your keys are immutable, and you have used synchronization properly."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (removeLRUEntry) &#123;</span><br><span class="line">            <span class="keyword">if</span> (reuse == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"reuse=null, header.after="</span> + <span class="keyword">this</span>.header.after + <span class="string">" header.before="</span> + <span class="keyword">this</span>.header.before + <span class="string">" key="</span> + key + <span class="string">" value="</span> + value + <span class="string">" size="</span> + <span class="keyword">this</span>.size + <span class="string">" maxSize="</span> + <span class="keyword">this</span>.maxSize + <span class="string">" This should not occur if your keys are immutable, and you have used synchronization properly."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.reuseMapping(reuse, hashIndex, hashCode, key, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.addMapping(hashIndex, hashCode, key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.addMapping(hashIndex, hashCode, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断容量的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> size &gt;= maxSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>容量未满就直接添加数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">super</span>.addMapping(hashIndex, hashCode, key, value);</span><br></pre></td></tr></table></figure>
<p>如果容量满了，就调用 <code>reuseMapping</code> 方法使用 LRU 算法对数据进行清除。</p>
<p>综合来说：<strong><code>LRUMap</code> 的本质是持有头结点的环回双链表结构，当使用元素时，就将该元素放在双链表 <code>header</code> 的前一个位置，在新增元素时，如果容量满了就会移除 <code>header</code>的后一个元素</strong>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文讲了防止数据重复提交的 6 种方法，首先是前端的拦截，通过隐藏和设置按钮的不可用来屏蔽正常操作下的重复提交。但为了避免非正常渠道的重复提交，我们又实现了 5 个版本的后端拦截：HashMap 版、固定数组版、双重检测锁的数组版、LRUMap 版和 LRUMap 的封装版。</p>
<h4 id="参考-amp-鸣谢"><a href="#参考-amp-鸣谢" class="headerlink" title="参考 &amp; 鸣谢"></a>参考 &amp; 鸣谢</h4><p><a href="https://blog.csdn.net/fenglllle/article/details/82659576" target="_blank" rel="noopener">https://blog.csdn.net/fenglllle/article/details/82659576</a></p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-08-02T06:50:50.272Z" itemprop="dateUpdated">2020-08-02 14:50:50</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/" target="_blank" rel="external">http://www.sjsmile.cn/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/</a>
        
    </div>
    <footer>
        <a href="http://www.sjsmile.cn">
            <img src="/img/avatar.jpg" alt="Smile">
            Smile
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.sjsmile.cn/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/&title=《最简单的 6 种防止数据重复提交的方法！》 — MY STUDY BLOG&pic=http://www.sjsmile.cn/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.sjsmile.cn/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/&title=《最简单的 6 种防止数据重复提交的方法！》 — MY STUDY BLOG&source=
转载:点击查看原文

模拟用户场景根据朋友的反馈，大致的场景是这样的，如下图所示：

                
                ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            
    <div id="comment"></div>




        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/08/02/看完让你彻底理解-WebSocket-原理/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">看完让你彻底理解 WebSocket 原理</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2020/08/02/java/MyBatis动态SQL/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">MyBatis动态SQL</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#模拟用户场景"><span class="post-toc-text">模拟用户场景</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前端拦截"><span class="post-toc-text">前端拦截</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#后端拦截"><span class="post-toc-text">后端拦截</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-基础版——HashMap"><span class="post-toc-text">1.基础版——HashMap</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-优化版——固定大小的数组"><span class="post-toc-text">2.优化版——固定大小的数组</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-扩展版——双重检测锁-DCL"><span class="post-toc-text">3.扩展版——双重检测锁(DCL)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-完善版——LRUMap"><span class="post-toc-text">4.完善版——LRUMap</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-最终版——封装"><span class="post-toc-text">5.最终版——封装</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#扩展知识——LRUMap-实现原理分析"><span class="post-toc-text">扩展知识——LRUMap 实现原理分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-text">总结</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#参考-amp-鸣谢"><span class="post-toc-text">参考 &amp; 鸣谢</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.png" data-alipay="/img/reward-alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    <!-- <iframe style="position:fixed;left:20px;bottom:20px;" frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=52 src="//music.163.com/outchain/player?type=2&id=466881971&auto=0&height=32"></iframe> -->
    <div id="music" style="position: fixed;left: 0;bottom: 0;z-index: 998;overflow: hidden;"></div>
</main>
<footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://sjsmi1e.github.io/" target="_blank">HOME</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                Smile &copy; 2015 - 2021
            </span>
        		
           	
           	<span>
           		<a href="http://www.beian.miit.gov.cn/" target="_blank">陕ICP备20009390号</a>
           	</span>
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

<div class="mask" id="mask"></div>
<a href="javascript:;" style="font-size:6px;" id="gotop" class="waves-effect waves-circle waves-light">
	<span class="icon icon-lg icon-chevron-up">
	 <br> <br><test id="read_percent"></test>
	</span>
</a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.sjsmile.cn/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/&title=《最简单的 6 种防止数据重复提交的方法！》 — MY STUDY BLOG&pic=http://www.sjsmile.cn/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.sjsmile.cn/2020/08/02/java/最简单的-6-种防止数据重复提交的方法！/&title=《最简单的 6 种防止数据重复提交的方法！》 — MY STUDY BLOG&source=
转载:点击查看原文

模拟用户场景根据朋友的反馈，大致的场景是这样的，如下图所示：

                
                ..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADIElEQVR42u3aQW7jQAwEwPz/095rgGyUblIBrEnpZCS2NDU+0GzOx0d8vT5dX//y9b/tna+feH3/2XOxsbGxT2K/Lq9r9vXr7xaXfzZZQ/Jl/GdV2NjY2MexZwudvTP5e76q9lPY2NjY2G2DsS+Ns1KKjY2NjT0rYLMy1lLbrwcbGxv7L7CTMvPd+2fNQx4hzQrebVkaNjY29tuzZ63Fe77+lfk2NjY29huzX+U1i5zytiRpOfYXNjY29knsvAAkh2M2AVAeBuUt0A8DZmxsbOxD2TkvWW4bS802dPhlYGNjYx/Kbkl5EWqpszFwXkqxsbGxz2Bv4ptoR+MjOAlm3zJhY2Njn8qeBTf5ItqQqGa0URQ2Njb2Qex2oXlJ27Qi+/Yj3yBsbGzs89h5zLSPimZXezwIGxsb+y+w27hn87DNGGBfbrGxsbHPYycf27cKbcw0O76Tt0PY2NjYJ7HbSD0Jle4aGyek/fgBGxsb+yT27MF58Ws3Oh8/bFoXbGxs7DPYdx2CzNuGu8bGq63HxsbGPoi9KQN5QD8LkvKhb7Kt2NjY2KeyN/s0O3Y5a1pmAVZx9gcbGxv7gewcfH27WcOQ3K0dIUTtEDY2NvZB7FlYvz+U0x4VSo7pJMUVGxsb+2x2/rH2yM6sjWlDqFU3ho2Njf1w9uynf1uQ2hLVlqu6yGFjY2Mfwc5j+s3INo+Z7ip4P3xh2NjY2Aexbwti4iiqfVZyt/0gGRsbG/sk9uyHfhsz5SPeWajUDp6xsbGxn85uo5xNkWuPAc2OCkXlChsbG/s49izQ2RSwTcuxb2CwsbGxT2XPSsKspG2OUc42MZqNYGNjYz+cvR/05oOBpCjmK6y3FRsbG/sI9qu87hrutu1EO6IYzqKxsbGxH8iejXjbpc9ez4YEq4EBNjY29mPZSdFqA6DNwc0Zph5LYGNjYx/Hni3iNbrygKkdORRhGTY2NjZ2EBjl5a2ltm1PNOjFxsbG/sPsJLLPh7WbCKkIpLCxsbGPY+cDgPb4ThskbYYKv5KlYWNjY789exPQ5EVocxgo36bZO7GxsbEfy/4H7P0+2n6Fh3QAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>



<!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>
<script>
	$(document).ready(function () {
		$.fancybox.defaults.hash = false;
	});
</script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4" data-pjax></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
        <script type="text/javascript" src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src="/js/Valine.min.js"></script>
<script type="text/javascript" src="/js/plugins/valine.js?v=1.4.4" data-pjax></script>

    
    



<script type="text/javascript" src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
<script type="text/javascript" src="/js/plugins/leancloud_visitors.js?v=1.4.4"></script>
<script>
    getCount();
</script>




    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '嗯？去哪里了！';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)咦!又好了!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>






<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<!--<script src="/js/jquery.dragscroll.js"></script>-->
<script src="/js/music.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/clipboard-use.js" data-pjax></script>
<script type="text/javascript" src="/js/alert.js"></script>
<script type="text/javascript" src="/js/reading-progress.js"></script>
<script type="text/javascript" src="/js/mypjax.js"></script>
</body>
</html>
